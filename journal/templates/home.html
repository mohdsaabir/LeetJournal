{% extends "base.html" %}
{% block content %}
<div class="text-center">
    <h2 class="text-3xl font-semibold mb-6">Welcome Back to Your LeetJournal ðŸ‘‹</h2>

    <!-- Stats Section -->
    <div class="grid grid-cols-2 gap-6 mb-10 max-w-md mx-auto">
        <div class="bg-white shadow rounded-xl p-6">
            <p class="text-xl font-bold text-green-600">{{ total_solved }}</p>
            <p class="text-gray-600">Solved Problems</p>
        </div>
        <div class="bg-white shadow rounded-xl p-6">
            <p class="text-xl font-bold text-yellow-500">{{ total_revision }}</p>
            <p class="text-gray-600">In Revision</p>
        </div>
    </div>

    <!-- Search -->
    <form action="/search/" method="get" class="mb-10">
        <input type="text" name="q" placeholder="Search your journal..."
            class="w-full max-w-lg border rounded-full px-6 py-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-400" />
    </form>

    <!-- Floating Alert Box -->
    <div id="alert-box" class="fixed top-5 right-5 z-50"></div>

    <!-- URL Form -->
    <form id="leetcode-form" class="max-w-lg mx-auto mb-10 flex">
        {% csrf_token %}
        <input type="url" id="leetcode-url" name="url" placeholder="Paste LeetCode URL to add new entry..." required
            class="flex-grow border rounded-l-full px-6 py-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-400" />
        <button type="submit"
            class="bg-gray-600 hover:bg-gray-900 text-white font-bold rounded-r-full px-6 transition-colors duration-300"
            aria-label="Add new entry">+</button>
    </form>

    <!-- Recently Solved -->
    <div class="text-left max-w-2xl mx-auto">
        <h3 class="text-2xl font-semibold mb-4">ðŸ•’ Recently Solved</h3>
        <ul class="space-y-3">
            {% for q in recent_questions %}
            <li class="bg-white shadow rounded-xl p-4 hover:shadow-md transition">
                <a href="{% url 'question_detail' q.id %}" class="font-semibold text-lg text-blue-600 hover:underline">
                    {{ q.question.question_no }} - {{ q.question.title }}
                </a>
                <p class="text-sm text-gray-500">Solved on {{ q.last_solved|date:"M d, Y" }}</p>
            </li>
            {% empty %}
            <li>No recent entries yet.</li>
            {% endfor %}
        </ul>
        <div class="mt-4 text-right">
            <a href="{% url 'all_solved' %}" class="text-indigo-600 hover:underline">View All â†’</a>
        </div>
    </div>
</div>

<!-- JavaScript to handle form and alert -->
<style>
    @keyframes slideFadeIn {
        0% {
            opacity: 0;
            transform: translateY(-10px);
        }

        100% {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .animated-alert {
        animation: slideFadeIn 0.3s ease-out;
    }
</style>

<script>
    document.getElementById("leetcode-form").addEventListener("submit", async function (e) {
        e.preventDefault();

        const url = document.getElementById("leetcode-url").value;
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        const res = await fetch("{% url 'new_entry' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
                "X-CSRFToken": csrfToken,
            },
            body: new URLSearchParams({ url }),
        });

        const data = await res.json();
        const alertBox = document.getElementById("alert-box");

        if (data.status !== "success") {
            const alert = document.createElement("div");
            alert.className =
                "animated-alert bg-[#7a756b] text-white px-6 py-4 rounded-lg shadow-lg mb-4 flex items-start justify-between gap-4 max-w-md";


            alert.innerHTML = `
                <div class="flex-1">
                    <p class="font-semibold">Error</p>
                    <p>${data.message}</p>
                </div>
                <button class="text-white hover:text-gray-300 text-xl font-bold leading-none focus:outline-none">&times;</button>
            `;

            alert.querySelector("button").addEventListener("click", () => alert.remove());

            alertBox.innerHTML = "";
            alertBox.appendChild(alert);

            document.getElementById("leetcode-url").value = "";
            document.getElementById("leetcode-url").focus();

            // Auto-dismiss after 4 seconds with fade
            setTimeout(() => {
                alert.style.transition = "opacity 0.4s ease";
                alert.style.opacity = "0";
                setTimeout(() => alert.remove(), 400);
            }, 4000);
        } else {
            window.location.href = data.redirect_url;
        }
    });
</script>

{% endblock %}